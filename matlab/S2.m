% S

% It is suggested that the y coordinate of the stopping
% point should be bigger than the y coordinate of the starting point for
% the S case. For kexi, it is suggested that it should be between 0.15 and 0.25.

function[xx,yy,k]=S2()

x=[3555        3508        3464        3420        3381        3345        3308 ...
    3281        3254        3234        3212        3199        3188        3179 ...
    3173        3169        3163        3157        3150        3145        3141 ...
    3132        3128        3124        3118        3114        3109        3104 ...
    3096        3092        3087        3080        3075        3069        3065 ...
    3059        3051        3046        3040        3037        3030        3027 ...
    3022        3013        3007        3000        2997        2992        2988 ...
    2987        2984        2980        2979        2976        2974        2976 ...
    2974        2975        2977        2978         ...
    2976        2976        2975        2975        2975        2976        2976 ...
    2975        2977        2976        2978        2976        2979        2978 ...
    2976        2976        2974        2978        2974        2975        2975 ...
    2974        2974        2975        2973        2975        2974        2975 ...
    2978        2974        2976        2972        2974        2974        2976 ...
    2976        2974        2976        2976        2974        2978        2975 ...
    2974        2973        2976        2975        2972        2975        2976 ...
    2976        2978        2971        2974        2974        2975        2977 ...
    2977        2977        2976        2979        2978        2976        2977 ...
    2976        2976        2976        2977        2976        2973        2970 ...
    2969        2970        2965        2963        2959        2954        2951 ...
    2944        2942        2938        2935        2927        2924        2919 ...
    2917        2910        2906        2903        2896        2889        2884 ...
    2884        2878        2875        2869        2866        2860        2856 ...
    2852        2852        2857        2864        2876        2888        2900 ...
    2923        2951        2979        3009        3053        3080        3119 ...
    3163        3203        3247];
y=[93         139         186         236         286         338   ...
    393         448         506         563         623         680  ...
    740         812         859         918         976        1038  ...
    1098        1158        1220        1283        1344        1404 ...
    1467        1527        1587        1647        1713        1773 ...
    1829        1887        1945        1997        2053        2109 ...
    2160        2211        2265        2310        2360        2402 ...
    2451        2505        2548        2596        2645        2691 ...
    2735        2772        2805        2831        2853        2866 ...
    2875        2878        2881        2879        2881        2878 ...
    2878        2879                2880 ...
    2879        2880        2879        2877        2879        2876 ...
    2879        2880        2878        2877        2879        2877 ...
    2879        2876        2877        2877        2875        2876 ...
    2874        2877        2877        2875        2877        2872 ...
    2873        2872        2872        2872        2873        2869 ...
    2872        2874        2871        2871        2872        2870 ...
    2869        2870        2871        2871        2870        2868 ...
    2867        2870        2867        2871        2871        2870 ...
    2869        2871        2872        2871        2869        2868 ...
    2870        2874        2872        2871        2870        2868 ...
    2872        2872        2868        2874        2874        2887 ...
    2901        2918        2943        2970        2999        3031 ...
    3067        3106        3144        3185        3226        3272 ...
    3317        3359        3407        3458        3503        3549 ...
    3600        3650        3699        3749        3798        3846 ...
    3899        3950        3999        4051        4104        4159 ...
    4212        4263        4314        4369        4423        4474 ...
    4528        4577        4630        4683        4746        4781 ...
    4827        4878        4928        4977];

a=y(2); %3100;
b=y(end-1); %;1500;
kexi=0.2;
D=5;

try
    
    v_x=zeros(1,length(x)-1);
    
    for i=1:1:(length(x)-1)
        
        v_x(i)=x(i+1)-x(i)+0.0001*randn; % calculate the velocity of the original data
        
    end
    
    
    
    % a=186; % use the y coordinate for starting point
    % b=4855;  % use the y coordinate for stopping point
    % kexi=0.2;
    % D=2; % the lane width
    
    k=1;
    num1=1;
    num2=1;
    xx=zeros(1,200);
    yy=zeros(1,200);
    vv=zeros(1,200);
    theta=zeros(1,200);
    l=zeros(1,200); % the lane car is using
    cl=zeros(1,200); % which direction car is changing lane
    
    for i=1:1:length(y)
        
        if (y(i)==a)
            num1=i;
            break;
        end
        if (y(i)>a)
            num1=i-1+(a-y(i-1))/(y(i)-y(i-1));
            break;
        end
        
    end
    
    yy(1)=a;
    xx(1)=x(floor(num1))+((a-y(floor(num1)))/(y(floor(num1)+1)-y(floor(num1))))*(x(floor(num1)+1)-x(floor(num1)));
    
    
    while (yy(k)<b)
        vv(k)=v_x(floor(num1))*(1+kexi*randn);  % vv is the velocity of the car
        num2=num1+(vv(k)/v_x(floor(num1)));
        
        xx(k+1)=x(floor(num2))+(num2-floor(num2))*(x(floor(num2)+1)-x(floor(num2)));
        yy(k+1)=y(floor(num2))+(num2-floor(num2))*(y(floor(num2)+1)-y(floor(num2)));
        
        % rn is a random number between (0,1), and l indicates which lane car is
        % using, cl denotes which direction car is changing lane.
        rn=rand;
        if ((l(k)==0)&&(rn<0.1))
            l(k+1)=1;
            cl(k+1)=1;
        end
        if ((l(k)==0)&&(rn>0.9))
            l(k+1)=-1;
            cl(k+1)=-1;
        end
        if ((l(k)==1)&&(rn<0.1))
            l(k+1)=0;
            cl(k+1)=-1;
        end
        if ((l(k)==-1)&&(rn>0.9))
            l(k+1)=0;
            cl(k+1)=1;
        end
        
        % change the coordinates with lane change
        
        theta(k+1)=atan((yy(k+1)-yy(k))./(xx(k+1)-xx(k)));
        
        xx(k+1)=xx(k+1)+D*sin(theta(k+1))*cl(k+1);
        yy(k+1)=yy(k+1)-D*cos(theta(k+1))*cl(k+1);
        
        num1=num2;
        k=k+1;
        
    end
    if isempty(find(isnan(xx))) &&  isempty(find(isnan(yy)))
        %         for i=1:1:k-1
        %             plot(xx(i),yy(i),'g');
        %             drawnow;
        %             %             pause(0.1);
        %         end
        plot(xx(1:k-1),yy(1:k-1),'g'); drawnow;
    end
catch ME
end

end



